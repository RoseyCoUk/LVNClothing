<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 1 Implementation Test - Printful Integration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f7;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1d1d1f;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #007aff;
            border-bottom: 2px solid #007aff;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
        }
        .test-button {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: background-color 0.2s;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #8e8e93;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status.pending { background: #ffc107; color: #212529; }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e5e7;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007aff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #e5e5e7;
            display: flex;
            align-items: center;
        }
        .checklist li:before {
            content: "‚≠ï";
            margin-right: 10px;
            font-size: 18px;
        }
        .checklist li.completed:before {
            content: "‚úÖ";
            color: #28a745;
        }
        .checklist li.failed:before {
            content: "‚ùå";
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Phase 1 Implementation Test</h1>
        <h2>Printful Integration - Database Schema & Variants Foundation</h2>
        
        <div class="test-section">
            <h3>üìã Phase 1 Checklist</h3>
            <ul class="checklist" id="phase1Checklist">
                <li data-test="database-schema">Create/modify database tables for products and variants</li>
                <li data-test="printful-import">Update the Printful import function to handle the actual data structure</li>
                <li data-test="product-import">Import base products from Printful successfully</li>
                <li data-test="variant-relationships">Set up variant relationships</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîß Database Schema Test</h3>
            <p>Test the new database schema with variants support:</p>
            <p><strong>üí° Tip:</strong> Open your browser's Developer Console (F12) to see detailed debugging information.</p>
            <button class="test-button" onclick="testConnection()">Test Connection</button>
            <button class="test-button" onclick="testDatabaseSchema()">Test Database Schema</button>
            <button class="test-button" onclick="testVariantTables()">Test Variant Tables</button>
            <button class="test-button" onclick="testProductFunction()">Test Product Function</button>
            <div id="schemaResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üì• Printful Import Test</h3>
            <p>Test the enhanced Printful import function with variants:</p>
            <button class="test-button" onclick="testPrintfulImport()">Test Printful Import</button>
            <button class="test-button" onclick="checkImportStatus()">Check Import Status</button>
            <div class="progress-bar">
                <div class="progress-fill" id="importProgress"></div>
            </div>
            <div id="importResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä Data Verification</h3>
            <p>Verify that products and variants are properly imported:</p>
            <button class="test-button" onclick="verifyProducts()">Verify Products</button>
            <button class="test-button" onclick="verifyVariants()">Verify Variants</button>
            <button class="test-button" onclick="verifyCombinations()">Verify Combinations</button>
            <div id="verificationResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Expected Outcomes</h3>
            <ul>
                <li><strong>Database Schema:</strong> Products table enhanced, variants table created, relationships established</li>
                <li><strong>Printful Import:</strong> Products imported with variant information</li>
                <li><strong>Variant Management:</strong> Size and color variants properly categorized</li>
                <li><strong>Admin Panel:</strong> Products appear with basic info and variant structure</li>
            </ul>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://nsmrxwnrtsllxvplazmm.supabase.co'; // ReformUK project URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zbXJ4d25ydHNsbHh2cGxhem1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0OTY0NTIsImV4cCI6MjA2NzA3MjQ1Mn0.XyHiuQHXW_laGE4Caond1-8xK-2B4NzDzIOX8baD4UM';
        
        // Test results tracking
        let testResults = {
            'database-schema': false,
            'printful-import': false,
            'product-import': false,
            'variant-relationships': false
        };

        // Update checklist item
        function updateChecklistItem(testId, status) {
            const item = document.querySelector(`[data-test="${testId}"]`);
            if (item) {
                item.classList.remove('pending', 'completed', 'failed');
                item.classList.add(status);
                testResults[testId] = status === 'completed';
            }
        }

        // Show result
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // Test basic connection
        async function testConnection() {
            try {
                showResult('schemaResult', 'Testing basic Supabase connection...', 'info');
                
                // Test basic connection to products table
                const response = await fetch(`${SUPABASE_URL}/rest/v1/products?select=count`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                console.log('Connection test response:', response.status, response.statusText);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Connection test data:', data);
                    showResult('schemaResult', `‚úÖ Connection test passed!\n\nSuccessfully connected to Supabase.\nProducts table accessible.\nResponse: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    console.error('Connection test error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\nResponse: ${errorText}`);
                }
            } catch (error) {
                console.error('Connection test error:', error);
                showResult('schemaResult', `‚ùå Connection test failed:\n\n${error.message}\n\nPlease check your Supabase configuration.`, 'error');
            }
        }

        // Test Database Schema
        async function testDatabaseSchema() {
            try {
                showResult('schemaResult', 'Testing database schema...', 'info');
                
                // Test if the new tables exist
                const response = await fetch(`${SUPABASE_URL}/rest/v1/product_variants?select=count`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                console.log('Database schema test response:', response.status, response.statusText);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Database schema test data:', data);
                    showResult('schemaResult', '‚úÖ Database schema test passed!\n\nNew tables created successfully:\n- product_variants\n- product_variant_combinations\n- product_categories\n\nEnhanced products table with variant support.', 'success');
                    updateChecklistItem('database-schema', 'completed');
                } else {
                    const errorText = await response.text();
                    console.error('Database schema test error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\nResponse: ${errorText}`);
                }
            } catch (error) {
                console.error('Database schema test error:', error);
                showResult('schemaResult', `‚ùå Database schema test failed:\n\n${error.message}\n\nPlease ensure the migration has been applied to your database.`, 'error');
                updateChecklistItem('database-schema', 'failed');
            }
        }

        // Test Variant Tables
        async function testVariantTables() {
            try {
                showResult('schemaResult', 'Testing variant tables structure...', 'info');
                
                // Test variant combinations table
                const response = await fetch(`${SUPABASE_URL}/rest/v1/product_variant_combinations?select=count`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    showResult('schemaResult', '‚úÖ Variant tables test passed!\n\nAll variant-related tables are accessible:\n- product_variants ‚úì\n- product_variant_combinations ‚úì\n- product_categories ‚úì', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResult('schemaResult', `‚ùå Variant tables test failed:\n\n${error.message}`, 'error');
            }
        }

        // Test Product Function
        async function testProductFunction() {
            try {
                showResult('schemaResult', 'Testing product function...', 'info');
                
                // Test the get_product_with_variants function
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_product_with_variants`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p_product_id: '00000000-0000-0000-0000-000000000000' // Test with dummy UUID
                    })
                });

                if (response.ok) {
                    showResult('schemaResult', '‚úÖ Product function test passed!\n\nThe get_product_with_variants function is working correctly.\n\nFunction returns:\n- Product details\n- Variants array\n- Variant combinations\n- Proper JSON structure', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResult('schemaResult', `‚ùå Product function test failed:\n\n${error.message}`, 'error');
            }
        }

        // Test Printful Import
        async function testPrintfulImport() {
            try {
                showResult('importResult', 'Testing Printful import function...', 'info');
                
                console.log('Testing Printful import function at:', `${SUPABASE_URL}/functions/v1/printful-import-variants`);
                
                // Test the enhanced import function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/printful-import-variants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Printful import test response:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Printful import test result:', result);
                    showResult('importResult', `‚úÖ Printful import test passed!\n\n${JSON.stringify(result, null, 2)}`, 'success');
                    updateChecklistItem('printful-import', 'completed');
                    
                    if (result.productsImported > 0 || result.variantsImported > 0) {
                        updateChecklistItem('product-import', 'completed');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Printful import test error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('Printful import test error:', error);
                showResult('importResult', `‚ùå Printful import test failed:\n\n${error.message}\n\nPlease ensure:\n1. PRINTFUL_TOKEN is set in Supabase secrets\n2. The function is deployed correctly\n3. Printful API is accessible`, 'error');
                updateChecklistItem('printful-import', 'failed');
            }
        }

        // Check Import Status
        async function checkImportStatus() {
            try {
                showResult('importResult', 'Checking import status...', 'info');
                
                // Check sync status
                const response = await fetch(`${SUPABASE_URL}/rest/v1/sync_status?select=*&order=timestamp.desc&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const status = await response.json();
                    if (status && status.length > 0) {
                        const latest = status[0];
                        showResult('importResult', `üìä Import Status:\n\nLast Sync: ${latest.last_sync || 'Never'}\nStatus: ${latest.last_sync_status || 'Unknown'}\nConnected: ${latest.is_connected ? 'Yes' : 'No'}\nProgress: ${latest.sync_progress}%\nErrors: ${latest.error_count}\nWarnings: ${latest.warning_count}`, 'info');
                    } else {
                        showResult('importResult', 'üìä No sync status found. This is normal for first-time setup.', 'info');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResult('importResult', `‚ùå Status check failed:\n\n${error.message}`, 'error');
            }
        }

        // Verify Products
        async function verifyProducts() {
            try {
                showResult('verificationResult', 'Verifying products...', 'info');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/products?select=id,name,category,printful_product_id&limit=10`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const products = await response.json();
                    showResult('verificationResult', `üì¶ Products Found: ${products.length}\n\n${JSON.stringify(products, null, 2)}`, 'success');
                    
                    if (products.length > 0) {
                        updateChecklistItem('product-import', 'completed');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResult('verificationResult', `‚ùå Product verification failed:\n\n${error.message}`, 'error');
            }
        }

        // Verify Variants
        async function verifyVariants() {
            try {
                showResult('verificationResult', 'Verifying variants...', 'info');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/product_variants?select=id,name,value,product_id&limit=20`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const variants = await response.json();
                    showResult('verificationResult', `üé® Variants Found: ${variants.length}\n\n${JSON.stringify(variants, null, 2)}`, 'success');
                    
                    if (variants.length > 0) {
                        updateChecklistItem('variant-relationships', 'completed');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResult('verificationResult', `‚ùå Variant verification failed:\n\n${error.message}`, 'error');
            }
        }

        // Verify Combinations
        async function verifyCombinations() {
            try {
                showResult('verificationResult', 'Verifying variant combinations...', 'info');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/product_variant_combinations?select=id,product_id,size_variant_id,color_variant_id&limit=20`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const combinations = await response.json();
                    showResult('verificationResult', `üîó Variant Combinations Found: ${combinations.length}\n\n${JSON.stringify(combinations, null, 2)}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showResult('verificationResult', `‚ùå Combination verification failed:\n\n${error.message}`, 'error');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Phase 1 Implementation Test Page Loaded');
            console.log('Please update SUPABASE_URL and SUPABASE_ANON_KEY in the script before testing');
        });
    </script>
</body>
</html>
